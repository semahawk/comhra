<!doctype html>
<html>
  <head>
    <title>Braithreachas</title>
    <meta charset="utf-8">
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/handy.js"></script>
    <link rel="stylesheet" href="/style.css" type="text/css">
    <script>
      $(document).ready(function(){
        var usersbox = $("#usersbox");
        var talk = $("#talk");
        var entry = $("#entry");
        var users = $("#users");
        var socket = io.connect('http://176.107.172.14:13013');

        /* position the users box nicely */
        usersbox.css("left", talk.width());
        /* focus on the input */
        entry.focus();
        /* scroll to the bottom */
        window.scrollBy(0, 1000000);
        $(".message").css("color", "#525252");

        socket.on('connect', function(){
          window.scrollBy(0, 1000000);
          var name, color;
          if (handy.getCookie('known') !== null){
            name = handy.getCookie('known').split(":")[0];
            color = handy.getCookie('known').split(":")[1];
          } else {
            name = prompt("Nick");
            color = prompt("Kolor (w formacie /#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})/)");
          }
          handy.setCookie('known', name + ":" + color, 60 * 60 * 24 * 7);
          socket.emit('adduser', name, color);
        });

        socket.on('disconnect', function(){
          $("#toolbar").css("background", "#525252");
          $(".message").css("color", "#525252");
          setInterval(function(){
            window.scrollBy(0, 1000000);
            socket.socket.reconnect();
          }, 1000);
        });

        socket.on('set cookie', function(key, value){
          handy.setCookie(key, value, 60 * 60 * 24 * 7);
        });

        socket.on('clear', function(){
          $("#talk").html("");
        });

        socket.on('updateuser', function(username, color){
          $("#username").html(username);
          $("#toolbar").css("background", color);
        });

        socket.on('updatetalk', function(username, color, msg, time){
          /* time passed here are seconds since epoch, but new Date() expects
             milliseconds */
          time *= 1000;
          msg = handy.toStaticHTML(msg);
          msg = msg.replace("&lt;3", "<span style='color: #cc3333';>&#x2665;</span>");
          msg = msg.replace("3&gt;", "<span style='color: #cc3333';>&#x2665;</span>");
          msg = msg.replace(handy.urlRE, '<a target="_blank" href="$&">$&</a>');
          talk.append("<tr class='message'>" +
            "<td class='date'>[" + handy.timeString(new Date(time)) + "]"+"</td>" +
            "<td class='nick' style='color: "+color+";'>&lt;" + username + "&gt;</td>" +
            "<td class='msg-text'>" + msg + "</td>" +
          "</tr>");
          window.scrollBy(0, 1000000);
        });

        socket.on('updateusers', function(users){
          var userscount = 0;
          var inside = "<ul>";
          for (var user in users){
            inside += "<li style='color: " + users[user].color + ";'>" + users[user].name + "</li>";
            userscount++;
          }
          inside += "</ul>";
          usersbox.html(inside);
        });

        socket.on('set topic', function(newtopic){
          $("#topic").html(newtopic);
        });

        entry.keypress(function(e){
          if (e.which == 13){
            socket.emit('sendchat', entry.val());
            window.scrollBy(0, 1000000);
            entry.val("");
            entry.focus();
          }
        });
      });
    </script>
  </head>
  <body>
    <table id="talk"></table>
    <div id="usersbox"></div>
    <div class="clear"></div>
    <div id="toolbar">
      <ul id="status">
        <li id="username"></a></li>
        <li id="topic" style="padding-right: 30px; float: right;">topic</a></li>
        <li class="clear"></li>
      </ul>
      <input tabindex="1" type="text" id="entry">
    </div>
  </body>
</html>
