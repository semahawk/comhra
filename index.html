<!doctype html>
<html>
  <head>
    <title>Braithreachas</title>
    <meta charset="utf-8">
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="/handy.js"></script>
    <link rel="stylesheet" href="/style.css" type="text/css">
    <script>
      $(document).ready(function(){
        scrollDown = function(){
          window.scrollBy(0, 1000000);
        };

        var usersbox = $("#usersbox");
        var talk = $("#talk");
        var entry = $("#entry");
        var users = $("#users");
        var socket = io.connect('http://176.107.172.14:13013');

        /* position the users box nicely */
        usersbox.css("left", talk.width());
        /* focus on the input */
        entry.focus();
        /* scroll to the bottom */
        scrollDown();
        $(".message").css("color", "#525252");

        socket.on('connect', function(){
          scrollDown();
          var name, color;
          if (handy.getCookie('known')){
            name = handy.getCookie('known').split(":")[0];
            color = handy.getCookie('known').split(":")[1];
          } else {
            name = prompt("Nick");
            color = prompt("Kolor (w formacie /#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})/)");
          }
          handy.setCookie('known', name + ":" + color, 60 * 60 * 24 * 7);
          socket.emit('adduser', name, color);
        });

        socket.on('disconnect', function(){
          $("#toolbar").css("background", "#525252");
          $(".message").css("color", "#525252");
          setInterval(function(){
            scrollDown();
            socket.socket.reconnect();
          }, 1000);
        });

        socket.on('set cookie', function(key, value){
          handy.setCookie(key, value, 60 * 60 * 24 * 7);
        });

        socket.on('clear', function(){
          $("#talk").empty();
        });

        socket.on('updateuser', function(username, color){
          $("#username").html(username);
          $("#toolbar").css("background", color);
        });

        socket.on('updatetalk', function(username, color, msg, time){
          var dateclass = "date";
          /* time passed here are seconds since epoch, but new Date() expects
             milliseconds */
          time *= 1000;
          var re = new RegExp(username);
          if (re.exec(msg)){
            dateclass = "date_mentioned";
          }
          /* sanitize user's name */
          username = handy.toStaticHTML(username);
          /* make there be hearts */
          username = username.replace("&lt;3", "<span style='color: #cc3333';>&#x2665;</span>");
          /* sanitize user's input */
          msg = handy.toStaticHTML(msg);
          /* make there be hearts! */
          msg = msg.replace("&lt;3", "<span style='color: #cc3333';>&#x2665;</span>");
          /* also, highlight any links, and make them clickable */
          msg = msg.replace(handy.urlRE, '<a target="_blank" href="$&">$&</a>');
          /* append the first, white, color */
          msg = "<span class='colWhite'>" + msg;
          /* now, replace any `? with an appropriate color */
          msg = msg.replace("`q", "</span><span class='colWhite'>");
          msg = msg.replace("`w", "</span><span class='colBlue'>");
          msg = msg.replace("`e", "</span><span class='colRed'>");
          msg = msg.replace("`r", "</span><span class='colGreen'>");
          msg = msg.replace("`t", "</span><span class='color:#E01B98'>");
          msg = msg.replace("`y", "</span><span class='color:#631BE0'>");
          msg = msg.replace("`u", "</span><span class='color:#E05D1B'>");
          msg = msg.replace("`i", "</span><span class='color:#5DE01B'>");
          /* and close any color that was the last */
          msg = msg + "</span>";
          /* now, actually append that message to the 'stream' */
          talk.append("<tr class='message'>" +
            "<td class='" + dateclass + "'>[" + handy.timeString(new Date(time)) + "]"+"</td>" +
            "<td class='nick' style='color: "+color+";'>&lt;" + username + "&gt;</td>" +
            "<td class='msg-text'>" + msg + "</td>" +
          "</tr>");
          scrollDown();
        });

        socket.on('updateusers', function(users){
          var userscount = 0;
          var inside = "<ul>";
          for (var user in users){
            inside += "<li style='color: " + users[user].color + ";'>" + users[user].name + "</li>";
            userscount++;
          }
          inside += "</ul>";
          usersbox.html(inside);
        });

        socket.on('set topic', function(newtopic){
          $("#topic").html(newtopic);
        });

        entry.keypress(function(e){
          if (e.which == 13){
            socket.emit('sendchat', entry.val());
            scrollDown();
            entry.val("");
            entry.focus();
          }
        });
      });
    </script>
  </head>
  <body>
    <table id="talk"></table>
    <div id="usersbox"></div>
    <div class="clear"></div>
    <div id="toolbar">
      <ul id="status">
        <li id="username"></a></li>
        <li id="topic" style="padding-right: 30px; float: right;">topic</a></li>
        <li class="clear"></li>
      </ul>
      <input tabindex="1" type="text" id="entry">
    </div>
  </body>
</html>
